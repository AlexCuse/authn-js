"use strict";function readCookie(e){return document.cookie.replace("(?:(?:^|.*;s*)"+e+"s*=s*([^;]*).*$)|^.*$","$1")}function deleteCookie(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;"}function refreshSession(e){KeratinAuthN.refresh().then(function(t){var n="https:"===window.location.protocol?"; secure":"";document.cookie=e+"="+t+n;var r=jwt_claims(t),o=(r.exp-r.iat)/2;setTimeout(function(){return refreshSession(e)},1e3*o)},function(t){"Unauthorized"===t&&deleteCookie(e)})}function jwt_claims(e){return JSON.parse(atob(e.split(".")[1]))}function url(e){if(!KeratinAuthN.ISSUER.length)throw"KeratinAuthN.ISSUER not set";return""+KeratinAuthN.ISSUER+e}function formData(e){return formDataItem("username",e.username)+"&"+formDataItem("password",e.password)}function formDataItem(e,t){return e+"="+encodeURIComponent(t)}function get(e,t){return jhr(function(n){n.open("GET",e+"?"+t),n.send()})}function post(e,t){return jhr(function(n){n.open("POST",e),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(t)})}function jhr(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.withCredentials=!0,r.onreadystatechange=function(){if(r.readyState==XMLHttpRequest.DONE){var e=r.responseText.length>1?JSON.parse(r.responseText):{};e.result?t(e.result):n(e.errors?e.errors:r.statusText)}},e(r)})}var KeratinAuthN={ISSUER:"",signup:function(e){return new Promise(function(t,n){return inflight?void n("duplicate"):(inflight=!0,void post(url("/accounts"),formData(e)).then(function(e){return t(e.id_token)},function(e){return n(e)}).then(function(){return inflight=!1}))})},isAvailable:function(e){return get(url("/accounts/available"),formDataItem("username",e)).then(function(e){return e.available})},refresh:function(){return get(url("/sessions/refresh"),"").then(function(e){return e.id_token})},login:function(e){return post(url("/sessions"),formData(e)).then(function(e){return e.id_token})},maintainSession:function(e){var t=readCookie(e);if(t){var n=jwt_claims(t),r=(n.exp-n.iat)/2,o=1e3*(n.iat+r),i=(new Date).getTime();i<n.iat||i>=o?refreshSession(e):setTimeout(function(){return refreshSession(e)},o-i)}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=KeratinAuthN;var inflight=!1;